---
title: "Goã§ãƒ†ã‚¹ãƒˆã—ã¦ã‚«ãƒãƒ¬ãƒƒã‚¸è¨ˆæ¸¬"
emoji: "ğŸ”"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["go"]
published: true
---


### ã¯ã˜ã‚ã«
å¹³ä¸‹CTO@sweeepã§ã™ã€‚Goè¨€èªã§ã®ãƒ†ã‚¹ãƒˆæ–¹æ³•ã‚„ã‚«ãƒãƒ¬ãƒƒã‚¸è¨ˆæ¸¬ãªã©ã‚’ã“ã¡ã‚‰ã‚’ã‚µãƒ³ãƒ—ãƒ«ã«è§£èª¬ã—ã¾ã™ã€‚â†’ [Goã§ãƒ•ã‚¡ã‚¤ãƒ«ã®Validationæ–¹æ³•ãªã©](https://zenn.dev/hirac/articles/dc537f0786cae9)
æœ¬è¨˜äº‹ã®å†…å®¹ã§ã™ã€‚
* Goã®ãƒ†ã‚¹ãƒˆ
* ãƒ†ã‚¹ãƒˆã®setup/teardown
* ã‚«ãƒãƒ¬ãƒƒã‚¸è¨ˆæ¸¬
* ãƒ†ã‚¹ãƒˆå®Ÿè¡Œçµæœ


### Goã®ãƒ†ã‚¹ãƒˆ

ã¾ãšxxx_test.goã¨ã„ã†ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã€testingã¨assertã‚’importã—ã¾ã™ï¼ˆpackageã¯ãƒ†ã‚¹ãƒˆå¯¾è±¡ã¨åŒã˜ï¼‰ã€‚
ãƒ†ã‚¹ãƒˆãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã«ã¯Testifyã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚
> Goãƒ†ã‚¹ãƒˆãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ« Testifyã‚’ã¤ã‹ã£ã¦ã¿ãŸ | DevelopersIO https://dev.classmethod.jp/articles/go-testify/
ä»¥ä¸‹ã®ã‚ˆã†ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒå«ã¾ã‚Œã¦ãŠã‚Šã€ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ãŒç°¡æ½”ã«ã‹ã‘ã¾ã™ã€‚
assert package
require package
mock package
suite package

```Go:utils/file/file_test.go
package file

import (
	"testing"
	"github.com/stretchr/testify/assert"
)
```

https://github.com/stretchr/testify/

é–¢æ•°åã«ã¯TestXXXã¨å…ˆé ­ã«[Test]ã‚’ã¤ã‘ã¾ã™ã€‚
```Go:utils/file/file_test.go
func TestCheckFileSize(t *testing.T) {
    ...
}
```

ä»¥ä¸‹ã¯ãƒ†ã‚¹ãƒˆå¯¾è±¡ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯å‡¦ç†ã§ã™ã€‚
```Go:utils/file/file.go
func CheckFileSize(size int64) (int64, error) {
	if size > MaxSize { // MaxSizeã‚ˆã‚Šå¤§ãã„å ´åˆã¯ã‚¨ãƒ©ãƒ¼
		return size, fmt.Errorf("size: %v error: %w", size, ErrFileSize)
	}
	return size, nil
}
```

ãƒ†ã‚¹ãƒˆå‡¦ç†ã¯ä¸‹è¨˜è¨˜äº‹ã‚’å‚è€ƒã«AAA(Arrange/Action/Assert)ã‚’æ„è­˜ã—ã¦ãƒ†ã‚¹ãƒˆæº–å‚™ã€ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œã€ãƒ†ã‚¹ãƒˆã®æ¤œè¨¼ã¨æ›¸ãã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚
> ãã‚Œã¯ã€ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿ã‚„ã™ãã™ã‚‹ãŸã‚ã®æŒ‡é‡ã§ã™ã€‚AAA ã¯ arrange, act, assert ã®ç•¥èªã§ã€arrange ã¯ã€æº–å‚™ã€ã€act ã¯ã€å®Ÿè¡Œã€ã€assertã¯ã€æ¤œè¨¼ã€ã‚’è¡¨ã—ã¾ã™ã€‚
>
> æº–å‚™ã¯ãƒ†ã‚¹ãƒˆç”¨ã®ãƒ‡ãƒ¼ã‚¿ã®ä½œæˆã€å®Ÿè¡Œã¯ãƒ†ã‚¹ãƒˆã—ãŸã„é–¢æ•°ã‚„ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ã€æ¤œè¨¼ã¯å®Ÿè¡Œã®çµæœå¾—ã‚‰ã‚ŒãŸå€¤ã‚„å¤‰åŒ–ãŒæœŸå¾…ã—ãŸã‚‚ã®ã§ã‚ã‚‹ã‹ã©ã†ã‹ã‚’ç¢ºèªã™ã‚‹ã“ã¨ã«ãªã‚Šã¾ã™ã€‚
>
> [AAA ã‚’æ„è­˜ã—ã¦å˜ä½“ãƒ†ã‚¹ãƒˆã‚’æ›¸ã - ãƒšãƒ‘ãƒœãƒ†ãƒƒã‚¯ãƒ–ãƒ­ã‚°](https://tech.pepabo.com/2021/08/23/writing-unit-test-with-aaa/)

https://tech.pepabo.com/2021/08/23/writing-unit-test-with-aaa/

```Go:utils/file/file_test.go
func TestCheckFileSize(t *testing.T) {
	// arrange
	f, _ := os.Open("../../sample/image.jpg")
	defer func() {
		_ = f.Close()
	}()

	// action
	fi, _ := f.Stat()
	_, actual := CheckFileSize(fi.Size())

	// assert
	assert.ErrorIs(t, nil, actual)
}
...
```

### ãƒ†ã‚¹ãƒˆã®setup/teardown

ãƒ†ã‚¹ãƒˆå‰ã«setupã§ã‚³ãƒ³ãƒ•ã‚£ã‚°ã‚„envè¨­å®šã—ãŸã‚Šã€ãƒ†ã‚¹ãƒˆçµ‚äº†å¾Œã«teardownã§ãƒ†ã‚¹ãƒˆç”¨ã®ãƒ‡ãƒ¼ã‚¿ã®ã‚¯ãƒªã‚¢å‡¦ç†ã—ãŸã„ã“ã¨ãŒã‚ã‚‹ã¨æ€ã„ã¾ã™ã€‚ä»¥ä¸‹ã®ã‚ˆã†ã«setupã¨teardownå®šç¾©ã—ã€TestMainã§å‘¼ã³å‡ºã—ã¾ã™ã€‚

```Go:utils/file/file_test.go
// ãƒ†ã‚¹ãƒˆã®é–‹å§‹ãƒ»çµ‚äº†
func TestMain(m *testing.M) {
	setup()
	ret := m.Run()
	if ret == 0 {
		teardown()
	}
	os.Exit(ret)
}

// ãƒ†ã‚¹ãƒˆåˆæœŸè¨­å®š
func setup() {
	log.Println("test start!")
}

// ãƒ†ã‚¹ãƒˆçµ‚äº†å‡¦ç†
func teardown() {
	log.Println("test end!")
}
```

å®Ÿè¡Œã™ã‚‹ã¨ä»¥ä¸‹ã®æ§˜ã«ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã®é–‹å§‹ã¨çµ‚äº†ã«setupã¨teardownãŒå‘¼ã°ã‚Œã¾ã™ã€‚

```
file $ go test -v -coverpkg=. ./...
2022/02/26 15:59:26 test start!
...
2022/02/26 15:59:26 test end!
```


### ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œã¨ã‚«ãƒãƒ¬ãƒƒã‚¸è¨ˆæ¸¬

ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œã¯ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§å®Ÿè¡Œã—ã¾ã™ã€‚[-coverpkg]ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§ã‚«ãƒãƒ¬ãƒƒã‚¸ã‚’è¨ˆæ¸¬ã—ã¾ã™ã€‚
```
$ go test -v -coverpkg=. ./...
```

ã‚«ãƒãƒ¬ãƒƒã‚¸è¨ˆæ¸¬çµæœã¯ä»¥ä¸‹ã®ã‚ˆã†ã«è¡¨ç¤ºã•ã‚Œã¾ã™ï¼ˆ80%ã§ã™ã­ï¼‰ã€‚
```
coverage: 80.0% of statements in .
ok      github.com/hirac1220/go-file-validate/utils/file        0.119s  coverage: 80.0% of statements in .
```

ã©ã®å‡¦ç†ãŒã‚«ãƒãƒ¼ã•ã‚Œã¦ã„ãªã„ã‹ç¢ºèªã—ãŸã„å ´åˆã¯[-coverprofile]ã§ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆã—ã€htmlã¸å¤‰æ›ã—å‡ºåŠ›ã—ã¾ã™ã€‚
```
$ go test -v -coverprofile=cover_file.out  -coverpkg=./...
$ go tool cover -html=cover_file.out -o cover_file.html
```
ã™ã‚‹ã¨æ·»ä»˜ã®ã‚ˆã†ã«ã‚«ãƒãƒ¼ã•ã‚Œã¦ã„ã‚‹å‡¦ç†ã¯ç·‘ã§ã€ã‚«ãƒãƒ¼ã•ã‚Œã¦ã„ãªã„å‡¦ç†ãŒèµ¤ãè¡¨ç¤ºã•ã‚Œã¾ã™ï¼ˆã‚µãƒ³ãƒ—ãƒ«ã§ã¯ã‚¨ãƒ©ãƒ¼å‡¦ç†ãŒã‚«ãƒãƒ¼ã§ãã¦ã„ãªã„ã§ã™ã­ï¼‰ã€‚

![](/images/9634a537c3ad2e/test_cover.png)

### ãƒ†ã‚¹ãƒˆå®Ÿè¡Œçµæœ

ã‚³ãƒãƒ³ãƒ‰æ‰“ã¤ã®ãŒã¡ã‚‡ã£ã¨ã¾ã‚“ã©ã„ã®ã§ã€Makefileã§ãƒ†ã‚¹ãƒˆå®Ÿæ–½ã—ã¦ã„ã¾ã™ã€‚
```makefile:utils/file/Makefile
test_file:
	go test -v -coverpkg=. ./...

test_cover_file:
	go test -v -coverprofile=cover_file.out  -coverpkg=./...
	go tool cover -html=cover_file.out -o cover_file.html
```

ãƒ†ã‚¹ãƒˆå®Ÿè¡Œçµæœã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã€ã™ã¹ã¦PASSã—ã¦ã‚«ãƒãƒ¬ãƒƒã‚¸ãŒ80%ã¨ã„ã†ã®ãŒã‚ã‹ã‚Šã¾ã™ï¼ˆå¤±æ•—ã™ã‚‹ã¨FAILãŒè¡¨ç¤ºã•ã‚Œã¾ã™ï¼‰

```
file $ make test_file
go test -v -coverpkg=. ./...
2022/02/26 15:59:26 test start!
=== RUN   TestCheckFileSize
--- PASS: TestCheckFileSize (0.00s)
=== RUN   TestValidateJPEG
--- PASS: TestValidateJPEG (0.00s)
=== RUN   TestValidateJPG
--- PASS: TestValidateJPG (0.00s)
=== RUN   TestValidatePNG
--- PASS: TestValidatePNG (0.00s)
=== RUN   TestJPGExtToContentType
--- PASS: TestJPGExtToContentType (0.00s)
=== RUN   TestJPEGExtToContentType
--- PASS: TestJPEGExtToContentType (0.00s)
=== RUN   TestPNGExtToContentType
--- PASS: TestPNGExtToContentType (0.00s)
PASS
coverage: 80.0% of statements in .
2022/02/26 15:59:26 test end!
ok      github.com/hirac1220/go-file-validate/utils/file        0.119s  coverage: 80.0% of statements in .
```

### ã¾ã¨ã‚
ä»Šå›ã¯Goè¨€èªã§ã®ãƒ†ã‚¹ãƒˆã¨ã‚«ãƒãƒ¬ãƒƒã‚¸è¨ˆæ¸¬ã¤ã„ã¦è§£èª¬ã—ã¾ã—ãŸã€‚
ãƒ†ã‚¹ãƒˆãŒã‚ã‚‹ãŠã‹ã’ã§ã€å¤§å¹…ãªä»•æ§˜å¤‰æ›´æ™‚ã‚„ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°æ™‚ã«ã‚‚æ€ã„åˆ‡ã£ãŸå¤‰æ›´ãŒã§ãã‚‹ã‚ˆã†ã«ãªã£ãŸã¨æ„Ÿã˜ã¦ã„ã¾ã™ã€‚
ã‚«ãƒãƒ¬ãƒƒã‚¸æ•°å€¤ç›®æ¨™ã§ã™ãŒ75%ãã‚‰ã„ãŒã‚ˆã„ã®ã‹ãªã€ã¨æ€ã£ã¦ã„ã¾ã™ã€‚ãŸã ã€ã‚«ãƒãƒ¬ãƒƒã‚¸ã‚’ç›®æ¨™ã«ç„¡ç†ãã‚Šãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã‚’æ›¸ãã®ã¯æœ¬æœ«è»¢å€’ãªæ°—ãŒã—ã¾ã™ã€‚é©åˆ‡ãªãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã¨ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ãƒ†ã‚¹ãƒˆã®çµ„åˆã›ã§å“è³ªã‚’ä½œã‚Šè¾¼ã‚€ã“ã¨ãŒå¤§äº‹ã‹ãªã€ã¨æ€ã£ã¦ã„ã¾ã™ã€‚
ä½¿ç”¨ã—ãŸã‚µãƒ³ãƒ—ãƒ«ã¯ã“ã¡ã‚‰ã®GitHubãƒ¬ãƒã‚¸ãƒˆãƒªã«ã‚ã‚Šã¾ã™ã€‚
https://github.com/hirac1220/go-file-validate

å¼Šç¤¾ã§ã¯ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ»ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ»CoreAIæ©Ÿèƒ½é–‹ç™ºã®ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã‚’ç©æ¥µçš„ã«æ¡ç”¨ã—ã¦ã„ã¾ã™ã€‚ã”èˆˆå‘³ã®ã‚ã‚‹æ–¹ã¯ä¸‹è¨˜ãƒªãƒ³ã‚¯ã‚ˆã‚Šã”å¿œå‹ŸãŠå¾…ã¡ã—ã¦ãŠã‚Šã¾ã™ï¼
https://www.wantedly.com/companies/sweeep/projects
